<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易游戏</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@latest/dist/chartjs-chart-financial.min.js"></script> -->
    <script src="https://unpkg.com/chartjs-chart-financial@latest/dist/chartjs-chart-financial.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .trading-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .long {
            background-color: #4CAF50;
            color: white;
        }
        .short {
            background-color: #f44336;
            color: white;
        }
        .close {
            background-color: #2196F3;
            color: white;
        }
        button:hover {
            opacity: 0.8;
        }
        .position-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .trade-history {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .profit {
            color: #4CAF50;
        }
        .loss {
            color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="chart-container">
            <canvas id="priceChart"></canvas>
        </div>
        <div class="trading-panel">
            <h2>交易面板</h2>
            <div class="button-group">
                <button class="long" onclick="openPosition('LONG')">开多</button>
                <button class="short" onclick="openPosition('SHORT')">开空</button>
                <button class="close" onclick="closePosition()">平仓</button>
            </div>
            <div class="position-info" id="positionInfo">
                <h3>当前持仓</h3>
                <p>暂无持仓</p>
            </div>
            <div class="trade-history">
                <h3>交易历史</h3>
                <table id="tradeHistory">
                    <thead>
                        <tr>
                            <th>方向</th>
                            <th>开仓价</th>
                            <th>平仓价</th>
                            <th>盈亏</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let chart;
        let currentPosition = null;
        let currentPrice = 0;
        let userId = 'user_' + Math.random().toString(36).substr(2, 9);
        let klineWs;
        let marketWs;

        // 初始化K线图表
        async function initChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // 新增：获取历史K线数据
            const response = await fetch(`/api/klines?symbol=IC9999&interval=30m&limit=100`);
            const klines = await response.json();
            
            // 转换数据格式
            const initialData = klines.map(k => ({
                x: new Date(k.timestamp),
                o: k.open,
                h: k.high,
                l: k.low,
                c: k.close
            }));
            
            // 初始化图表
            chart = new Chart(ctx, {
                type: 'candlestick',
                data: {
                    datasets: [{
                        label: 'IC9999 30m',
                        data: initialData,  // 使用API返回的数据
                        color: {
                            up: '#4CAF50',
                            down: '#F44336',
                            unchanged: '#2196F3',
                        }
                    }]
                },
                options: { /* ...原有配置... */ }
            });
            
            // 初始化WebSocket连接
            initKlineWebSocket();
        }
        
        // 初始化K线WebSocket
        function initKlineWebSocket() {
            // 修改为正确的WebSocket地址
            klineWs = new WebSocket('ws://localhost:8080/ws/kline');
            
            klineWs.onopen = function() {
                console.log("Connected to Kline WebSocket");
                // 不再需要手动发送"next_kline"
            };
                    
            klineWs.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'initial_klines') {
                    // Clear existing data
                    chart.data.datasets[0].data = [];
                    
                    // Add all initial K-lines
                    data.data.forEach(kline => {
                        chart.data.datasets[0].data.push({
                            x: new Date(kline.timestamp),
                            o: kline.open,
                            h: kline.high,
                            l: kline.low,
                            c: kline.close
                        });
                        currentPrice = kline.close;
                    });
                    
                    chart.update();
                    updatePosition(currentPrice);
                }
                else if (data.type === 'kline_window_update') {
                    // Update with new window of K-lines
                    chart.data.datasets[0].data = [];
                    
                    data.data.forEach(kline => {
                        chart.data.datasets[0].data.push({
                            x: new Date(kline.timestamp),
                            o: kline.open,
                            h: kline.high,
                            l: kline.low,
                            c: kline.close
                        });
                        currentPrice = kline.close;
                    });
                    
                    chart.update();
                    updatePosition(currentPrice);
                }
            };
        }

        // 开仓
        async function openPosition(side) {
            if (currentPosition) {
                alert('请先平掉当前持仓');
                return;
            }

            const response = await fetch('/api/trade/open', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user_id: userId,
                    symbol: 'BTCUSDT',
                    side: side,
                    size: 1,
                    price: currentPrice
                })
            });

            currentPosition = await response.json();
            updatePositionInfo();
        }

        // 平仓
        async function closePosition() {
            if (!currentPosition) {
                alert('没有持仓');
                return;
            }

            const response = await fetch(`/api/trade/close/${currentPosition.id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    exit_price: currentPrice
                })
            });

            const closedTrade = await response.json();
            addTradeHistory(closedTrade);
            currentPosition = null;
            updatePositionInfo();
        }

        // 更新持仓信息
        function updatePosition(price) {
            if (!currentPosition) return;

            const entryPrice = currentPosition.entry_price;
            const pnl = currentPosition.side === 'LONG' 
                ? (price - entryPrice) 
                : (entryPrice - price);
            
            document.getElementById('positionInfo').innerHTML = `
                <h3>当前持仓</h3>
                <p>方向: ${currentPosition.side}</p>
                <p>开仓价: ${entryPrice}</p>
                <p>当前价: ${price}</p>
                <p class="${pnl >= 0 ? 'profit' : 'loss'}">
                    盈亏: ${pnl.toFixed(2)} USDT
                </p>
            `;
        }

        // 添加交易历史
        function addTradeHistory(trade) {
            const tbody = document.querySelector('#tradeHistory tbody');
            const row = document.createElement('tr');
            const pnl = trade.pnl;
            
            row.innerHTML = `
                <td>${trade.side}</td>
                <td>${trade.entry_price}</td>
                <td>${trade.exit_price}</td>
                <td class="${pnl >= 0 ? 'profit' : 'loss'}">${pnl.toFixed(2)}</td>
            `;
            
            tbody.insertBefore(row, tbody.firstChild);
        }

        // 更新持仓信息面板
        function updatePositionInfo() {
            if (!currentPosition) {
                document.getElementById('positionInfo').innerHTML = `
                    <h3>当前持仓</h3>
                    <p>暂无持仓</p>
                `;
                return;
            }
            updatePosition(currentPrice);
        }

        // 页面加载完成后初始化
        window.onload = async function() {
            await initChart();
            initWebSocket();
        };
    </script>
</body>
</html>
