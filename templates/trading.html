<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>量化交易图表</title>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4"></script>
  <!-- 更换Lightweight Charts CDN源 -->
  <script src="https://unpkg.com/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>
  <!-- 添加SQL.js依赖 -->
  <script src="https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/sql-wasm.js"></script>
  
  <style>
    /* 保持原有样式不变 */
    body { font-family: Arial, sans-serif; margin: 20px; }
    #chart-container { width: 1000px; height: 600px; margin: 20px 0; position: relative; }
    .controls { margin: 20px 0; padding: 10px; background: #f5f5f5; border-radius: 5px; }
    button { padding: 8px 15px; margin: 0 5px; cursor: pointer; }
    #openLong { background-color: #4CAF50; color: white; }
    #openShort { background-color: #F44336; color: white; }
    #closePosition { background-color: #2196F3; color: white; }
    #pnlDisplay { margin-left: 20px; font-weight: bold; padding: 8px 15px; background: #333; color: white; border-radius: 4px; }
    select { padding: 5px; margin: 0 10px 0 5px; }
    #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; 
      color: white; font-size: 24px; }
  </style>
</head>
<body>
  <div id="loading">加载数据库文件中...</div>
  
  <h1>量化交易图表</h1>
  <div id="chart-container"></div>
  
  <div class="controls">
    <!-- 控件保持原有结构不变 -->
    <div>
      <label>图表类型:</label>
      <select id="chart-type">
        <option value="candlestick" selected>蜡烛图</option>
        <option value="bar">柱状图</option>
      </select>
      <label>比例类型:</label>
      <select id="price-scale-type">
        <option value="right" selected>右侧</option>
        <option value="left">左侧</option>
        <option value="log">对数</option>
      </select>
      <label>颜色方案:</label>
      <select id="color-scheme">
        <option value="muted" selected>柔和</option>
        <option value="neon">霓虹</option>
      </select>
      <button id="toggle-line">切换趋势线</button>
      <button id="loadMore">加载更多数据</button>
    </div>
    
    <div style="margin-top: 15px;">
      <button id="openLong">开多</button>
      <button id="openShort">开空</button>
      <button id="closePosition">平仓</button>
      <span id="pnlDisplay">当前盈亏: 0</span>
    </div>
  </div>

  <div id="tradeInfo" style="margin: 20px 0; padding: 10px; background: #e0e0e0; border-radius: 5px;">
    当前持仓：无<br>
    入场价格：--<br>
    浮动盈亏：0<br>
    累计盈亏：0
  </div>
  
  <script>
    // 添加SQL.js初始化代码
    async function initSQL() {
      const config = {
        locateFile: filename => `https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/${filename}`
      };
      return initSqlJs(config);
    }

    // 全局变量
    let db;
    let chart;
    let candleSeries;
    let lineSeries;
    let currentPrice = 0;
    let position = null;
    let entryPrice = 0;
    let pnl = 0;
    let loadedCount = 60;
    let isLineVisible = false;
    let currentOffset = 0; // 新增偏移量控制
    let cumulativePnl = 0;  // 新增：累计盈亏变量
    let totalPnl = 0;  // 改为累计盈亏
    let tradeHistory = [];  // 新增交易历史记录

    // 初始化图表（修复LightweightCharts引用）
    function initChart() {
      const chartContainer = document.getElementById('chart-container');
      chart = LightweightCharts.createChart(chartContainer, {
        width: 1000,
        height: 500,
        layout: { backgroundColor: '#ffffff', textColor: 'rgba(0, 0, 0, 0.9)' },
        grid: {
          vertLines: { color: 'rgba(0, 0, 0, 0.1)' },
          horzLines: { color: 'rgba(0, 0, 0, 0.1)' }
        },
        rightPriceScale: { visible: true, borderColor: 'rgba(0, 0, 0, 0.1)' },
        timeScale: { borderColor: 'rgba(0, 0, 0, 0.1)', timeVisible: true }
      });

      candleSeries = chart.addCandlestickSeries({
        upColor: '#26a69a',
        downColor: '#ef5350',
        borderVisible: true,
        wickUpColor: '#26a69a',
        wickDownColor: '#ef5350',
      });

      lineSeries = chart.addLineSeries({
        color: '#2962FF',
        lineWidth: 2,
        visible: false,
      });
    }

    // 加载数据库文件（添加错误处理）
    async function loadDatabase() {
      try {
        document.getElementById('loading').style.display = 'flex';
        const SQL = await initSQL();
        const response = await fetch('/static/trading_data.db');
        if (!response.ok) throw new Error('数据库加载失败');
        
        const buffer = await response.arrayBuffer();
        db = new SQL.Database(new Uint8Array(buffer));
        console.log('数据库加载完成');
        loadChartData();
      } catch (error) {
        console.error('加载错误:', error);
        alert('加载数据库时出错：' + error.message);
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    }

    // 加载K线数据（修改后的逻辑）
    function loadChartData() {
      if (!db) {
        console.error('数据库未初始化');
        return;
      }

      const stmt = db.prepare(`
        SELECT timestamp, open, high, low, close 
        FROM trading_data 
        ORDER BY timestamp ASC 
        LIMIT ${loadedCount} OFFSET ${currentOffset}
      `);

      const barData = [];
      const lineData = [];

      while (stmt.step()) {
        const row = stmt.getAsObject();
        const date = luxon.DateTime.fromSQL(row.timestamp);
        if (!date.isValid) {
          console.error('无效的时间戳:', row.timestamp);
          continue;
        }

        const time = date.toJSDate().getTime() / 1000;
        barData.push({ time, open: row.open, high: row.high, low: row.low, close: row.close });
        lineData.push({ time, value: row.close });
      }

      stmt.free();

      if (barData.length > 0) {
        currentPrice = barData[barData.length - 1].close;
        candleSeries.setData(barData);
        lineSeries.setData(lineData);
        chart.timeScale().fitContent();

        updateTradeInfo();  // 新增，更新交易信息面板
      }
    }

    // 交易逻辑（保持不变）
    function updatePnl() {
      // 如果有持仓，则计算当前未平仓盈亏，并累加之前累计盈亏
      let displayPnl = cumulativePnl;
      if (position === 'long') {
        displayPnl += (currentPrice - entryPrice) * 100;
      } else if (position === 'short') {
        displayPnl += (entryPrice - currentPrice) * 100;
      }
      const pnlElement = document.getElementById('pnlDisplay');
      pnlElement.textContent = `累计盈亏: ${displayPnl.toFixed(2)}`;
      pnlElement.style.color = displayPnl > 0 ? '#4CAF50' : displayPnl < 0 ? '#F44336' : 'white';
    }
    
    function updateTradeInfo() {
      let info = '';
      if (position) {
        info += `当前持仓：${position === 'long' ? '多头' : '空头'}<br>`;
        info += `入场价格：${entryPrice.toFixed(2)}<br>`;
        const floatingPnl = position === 'long' ? (currentPrice - entryPrice) * 100 : (entryPrice - currentPrice) * 100;
        info += `浮动盈亏：${floatingPnl.toFixed(2)}<br>`;
      } else {
        info += `当前持仓：无<br>`;
        info += `入场价格：--<br>`;
        info += `浮动盈亏：0<br>`;
      }
      info += `累计盈亏：${cumulativePnl.toFixed(2)}`;
      document.getElementById('tradeInfo').innerHTML = info;
    }    

    // 修改加载更多按钮事件
    document.getElementById('loadMore').addEventListener('click', () => {
      currentOffset += 1; // 每次偏移量+1
      document.getElementById('loading').style.display = 'none';
      setTimeout(() => {
        loadChartData();
        document.getElementById('loading').style.display = 'none';
      }, 100);
    });
    
    document.getElementById('openLong').addEventListener('click', () => {
      if (!position) {
        position = 'long';
        entryPrice = currentPrice;
        alert(`开多成功! 入场价格: ${entryPrice.toFixed(2)}`);
        updatePnl();
        updateTradeInfo();  // 新增，更新交易信息面板
      } else {
        alert('您已有持仓，请先平仓!');
      }
    });

    document.getElementById('openShort').addEventListener('click', () => {
      if (!position) {
        position = 'short';
        entryPrice = currentPrice;
        alert(`开空成功! 入场价格: ${entryPrice.toFixed(2)}`);
        updatePnl();
        updateTradeInfo();  // 新增，更新交易信息面板
      } else {
        alert('您已有持仓，请先平仓!');
      }
    });

    document.getElementById('closePosition').addEventListener('click', () => {
      if (position) {
        const profit = position === 'long'
          ? (currentPrice - entryPrice) * 100
          : (entryPrice - currentPrice) * 100;
        alert(`平仓成功! 入场价: ${entryPrice.toFixed(2)}, 平仓价: ${currentPrice.toFixed(2)}, 本次盈亏: ${profit.toFixed(2)}`);
        
        cumulativePnl += profit; // 将本次盈利/亏损累计
        position = null;
        entryPrice = 0;
        updatePnl();
        updateTradeInfo();  // 新增，更新交易信息面板
      } else {
        alert('您没有持仓!');
      }
    });

    // 启动应用
    initChart();
    loadDatabase();
  </script>
</body>
</html>