<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>量化交易图表</title>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.0"></script>
  
  <!-- 注册财务图表组件，确保 "candlestick" 类型可用 -->
  <script>
    if (window.CandlestickController && window.CandlestickElement && window.FinancialScale) {
      Chart.register(window.CandlestickController, window.CandlestickElement, window.FinancialScale);
    } else {
      console.error("无法找到财务图表相关组件。");
    }
  </script>
  
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #chart-container {
      width: 1000px;
      margin: 20px 0;
    }
    .controls {
      margin: 20px 0;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 5px;
    }
    button {
      padding: 8px 15px;
      margin: 0 5px;
      cursor: pointer;
    }
    #openLong {
      background-color: #4CAF50;
      color: white;
    }
    #openShort {
      background-color: #F44336;
      color: white;
    }
    #closePosition {
      background-color: #2196F3;
      color: white;
    }
    #pnlDisplay {
      margin-left: 20px;
      font-weight: bold;
      padding: 8px 15px;
      background: #333;
      color: white;
      border-radius: 4px;
    }
    select {
      padding: 5px;
      margin: 0 10px 0 5px;
    }
    #loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 24px;
    }
  </style>
</head>
<body>
  <div id="loading">加载数据库文件中...</div>
  
  <h1>量化交易图表</h1>
  
  <div id="chart-container">
    <canvas id="chart"></canvas>
  </div>
  
  <div class="controls">
    <div>
      <label>图表类型:</label>
      <select id="type">
        <option value="candlestick" selected>蜡烛图</option>
        <option value="ohlc">OHLC图</option>
      </select>
      
      <label>比例类型:</label>
      <select id="scale-type">
        <option value="linear" selected>线性</option>
        <option value="logarithmic">对数</option>
      </select>
      
      <label>颜色方案:</label>
      <select id="color-scheme">
        <option value="muted" selected>柔和</option>
        <option value="neon">霓虹</option>
      </select>
      
      <label>边框:</label>
      <select id="border">
        <option value="true" selected>显示</option>
        <option value="false">隐藏</option>
      </select>
      
      <label>混合图表:</label>
      <select id="mixed">
        <option value="true">是</option>
        <option value="false" selected>否</option>
      </select>
      
      <button id="update">更新</button>
      <button id="loadMore">加载更多数据</button>
    </div>
    
    <div style="margin-top: 15px;">
      <button id="openLong">开多</button>
      <button id="openShort">开空</button>
      <button id="closePosition">平仓</button>
      <span id="pnlDisplay">实时盈亏: 0</span>
    </div>
  </div>
  
  <script>
    // 全局变量
    var db;
    var chart;
    var currentPrice = 0;
    var position = null; // null: 无仓位, 'long': 多头, 'short': 空头
    var entryPrice = 0;
    var pnl = 0;
    var loadedCount = 60; // 初始加载60条数据
    var ctx = document.getElementById('chart').getContext('2d');
    ctx.canvas.width = 1000;
    ctx.canvas.height = 500;
    
    // 显示加载中
    document.getElementById('loading').style.display = 'flex';
    
    // 动态加载 SQL.js 脚本，注意这里检查 initSqlJs
    function loadSQLJs() {
      return new Promise((resolve, reject) => {
        if (typeof initSqlJs !== 'undefined') {
          resolve();
        } else {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/sql-wasm.js';
          script.onload = () => {
            // 脚本加载后，再次检查 initSqlJs 是否已定义
            if (typeof initSqlJs !== 'undefined') {
              resolve();
            } else {
              reject(new Error('SQL.js 脚本加载后仍未定义 initSqlJs'));
            }
          };
          script.onerror = () => {
            reject(new Error('加载 SQL.js 脚本失败'));
          };
          document.head.appendChild(script);
        }
      });
    }
    
    // 修正的 initSQL 函数，依赖新的 loadSQLJs()
    function initSQL() {
      return new Promise((resolve, reject) => {
        loadSQLJs().then(() => {
          const config = {
            locateFile: filename => `https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/${filename}`
          };
          if (typeof initSqlJs !== 'undefined') {
            initSqlJs(config).then(function(SQL) {
              resolve(SQL);
            }).catch(err => {
              reject(err);
            });
          } else {
            reject(new Error('SQL.js 加载后依然不可用'));
          }
        }).catch(error => {
          reject(error);
        });
      });
    }
    
    // 加载数据库文件（要求 trading_data.db 放在 static/ 文件夹下）
    async function loadDatabase() {
      try {
        document.getElementById('loading').style.display = 'flex';
        
        const SQL = await initSQL();
        
        const response = await fetch('/static/trading_data.db');
        if (!response.ok) throw new Error('数据库加载失败');
        
        const buffer = await response.arrayBuffer();
        db = new SQL.Database(new Uint8Array(buffer));
        console.log('数据库加载完成');
        
        loadChartData();
      } catch (error) {
        console.error('加载错误:', error);
        alert('加载数据库时出错：' + error.message);
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    }
    
    // 从数据库加载K线数据
    function loadChartData() {
      const stmt = db.prepare(`
        SELECT timestamp, open, high, low, close 
        FROM trading_data 
        ORDER BY timestamp ASC 
        LIMIT ${loadedCount}
      `);
      
      const barData = [];
      const lineData = [];
      
      while (stmt.step()) {
        const row = stmt.getAsObject();
        // 使用 fromSQL 解析时间戳，并判断解析是否有效
        const date = luxon.DateTime.fromSQL(row.timestamp);
        if (!date.isValid) {
          console.error('时间解析失败，数据：', row.timestamp);
          continue;
        }
        
        barData.push({
          x: date.valueOf(),
          o: row.open,
          h: row.high,
          l: row.low,
          c: row.close
        });
        
        lineData.push({
          x: date.valueOf(),
          y: row.close
        });
      }
      
      stmt.free();
      
      // 设置当前价格
      if (barData.length > 0) {
        currentPrice = barData[barData.length - 1].c;
      }
      
      // 初始化或更新图表
      if (!chart) {
        initChart(barData, lineData);
      } else {
        updateChart(barData, lineData);
      }
      
      updatePnl();
    }
    
    // 初始化图表
    function initChart(barData, lineData) {
      chart = new Chart(ctx, {
        type: 'candlestick',
        data: {
          datasets: [{
            label: 'BTC/USDT',
            data: barData,
            backgroundColor: {
              up: 'rgba(0, 150, 0, 0.8)',
              down: 'rgba(150, 0, 0, 0.8)',
              unchanged: 'rgba(150, 150, 150, 0.8)',
            },
            borderColor: {
              up: 'rgba(0, 150, 0, 1)',
              down: 'rgba(150, 0, 0, 1)',
              unchanged: 'rgba(150, 150, 150, 1)',
            },
            borderWidth: 1
          }, {
            label: '收盘价',
            type: 'line',
            data: lineData,
            hidden: true,
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 2,
            pointRadius: 0
          }]
        },
        options: {
          responsive: false,
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'day'
              }
            },
            y: {
              type: 'linear'
            }
          }
        }
      });
    }
    
    // 更新图表数据
    function updateChart(barData, lineData) {
      chart.data.datasets[0].data = barData;
      chart.data.datasets[1].data = lineData;
      chart.update();
    }
    
    // 加载更多数据
    document.getElementById('loadMore').addEventListener('click', function() {
      loadedCount += 30; // 每次加载30条
      document.getElementById('loading').style.display = 'flex';
      setTimeout(() => {
        loadChartData();
        document.getElementById('loading').style.display = 'none';
      }, 100);
    });
    
    // 更新图表样式
    var update = function() {
      var dataset = chart.config.data.datasets[0];
      
      // 图表类型
      var type = document.getElementById('type').value;
      chart.config.type = type;
      
      // 比例类型
      var scaleType = document.getElementById('scale-type').value;
      chart.config.options.scales.y.type = scaleType;
      
      // 颜色方案
      var colorScheme = document.getElementById('color-scheme').value;
      if (colorScheme === 'neon') {
        dataset.backgroundColor = {
          up: '#01ff01',
          down: '#fe0000',
          unchanged: '#999',
        };
        dataset.borderColor = {
          up: '#01ff01',
          down: '#fe0000',
          unchanged: '#999',
        };
      } else {
        dataset.backgroundColor = {
          up: 'rgba(0, 150, 0, 0.8)',
          down: 'rgba(150, 0, 0, 0.8)',
          unchanged: 'rgba(150, 150, 150, 0.8)',
        };
        dataset.borderColor = {
          up: 'rgba(0, 150, 0, 1)',
          down: 'rgba(150, 0, 0, 1)',
          unchanged: 'rgba(150, 150, 150, 1)',
        };
      }
      
      // 边框
      var border = document.getElementById('border').value;
      if (border === 'false') {
        dataset.borderWidth = 0;
      } else {
        dataset.borderWidth = 1;
      }
      
      // 混合图表
      var mixed = document.getElementById('mixed').value;
      if (mixed === 'true') {
        chart.config.data.datasets[1].hidden = false;
      } else {
        chart.config.data.datasets[1].hidden = true;
      }
      
      chart.update();
    };
    
    // 交易逻辑
    function updatePnl() {
      if (position === 'long') {
        pnl = (currentPrice - entryPrice) * 100;
      } else if (position === 'short') {
        pnl = (entryPrice - currentPrice) * 100;
      } else {
        pnl = 0;
      }
      
      document.getElementById('pnlDisplay').textContent = `实时盈亏: ${pnl.toFixed(2)}`;
      
      // 根据盈亏设置颜色
      var pnlElement = document.getElementById('pnlDisplay');
      if (pnl > 0) {
        pnlElement.style.color = '#4CAF50';
      } else if (pnl < 0) {
        pnlElement.style.color = '#F44336';
      } else {
        pnlElement.style.color = 'white';
      }
    }
    
    // 事件监听
    document.getElementById('openLong').addEventListener('click', function() {
      if (position === null) {
        position = 'long';
        entryPrice = currentPrice;
        alert(`开多成功! 入场价格: ${entryPrice.toFixed(2)}`);
        updatePnl();
      } else {
        alert('您已有持仓，请先平仓!');
      }
    });
    
    document.getElementById('openShort').addEventListener('click', function() {
      if (position === null) {
        position = 'short';
        entryPrice = currentPrice;
        alert(`开空成功! 入场价格: ${entryPrice.toFixed(2)}`);
        updatePnl();
      } else {
        alert('您已有持仓，请先平仓!');
      }
    });
    
    document.getElementById('closePosition').addEventListener('click', function() {
      if (position !== null) {
        var exitPrice = currentPrice;
        var profit = position === 'long' ? (exitPrice - entryPrice) * 100 : (entryPrice - exitPrice) * 100;
        alert(`平仓成功! 入场价: ${entryPrice.toFixed(2)}, 平仓价: ${exitPrice.toFixed(2)}, 盈亏: ${profit.toFixed(2)}`);
        position = null;
        entryPrice = 0;
        updatePnl();
      } else {
        alert('您没有持仓!');
      }
    });
    
    document.getElementById('update').addEventListener('click', update);
    
    // 启动应用
    loadDatabase();
  </script>
</body>
</html>
